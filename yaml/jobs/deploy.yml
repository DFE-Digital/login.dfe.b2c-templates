parameters:
- name: environmentName
  type: string
- name: environmentId
  type: string
- name: serviceConnection
  type: string
- name: subscriptionId
  type: string
- name: clientId
  type: string
- name: clientSigningKey
  type: string
- name: graphAccessClientId
  type: string
- name: graphAccessClientSecret
  type: string
- name: deploymentPrimaryLocation
  type: string
- name: deploymentSecondaryLocation
  type: string
- name: deployApim
  type: boolean
  default: false
- name: eapimEnvironmentName
  type: string
  values:
  - Development
  - Test
  - Oat
  - Production

jobs:
- template: /Application/dotnet/jobs/deploy-function.yml@devopsTemplates
  parameters:
      applicationName: $(applicationName)
      environmentName: ${{parameters.environmentName}}
      serviceConnection: ${{parameters.serviceConnection}}
      subscriptionId: ${{parameters.subscriptionId}}
      resourceGroupName: s141${{parameters.environmentId}}-${{parameters.environmentName}}$(applicationName)
      location: ${{parameters.deploymentPrimaryLocation}}
      templatePath: '$(Build.SourcesDirectory)/arm/template.json'
      overrideParameters: '
      -applicationName "$(applicationName)"
      -environmentName "${{parameters.environmentName}}"
      -servicePlanSkuName "$(functionServicePlanSkuName)"
      -servicePlanSkuTier "$(functionServicePlanSkuTier)"
      -servicePlanSkuCount "$(functionServicePlanSkuCount)"
      -secondaryStorageLocation "${{parameters.deploymentSecondaryLocation}}"
      -alertWebHookUrl "http://www.test.com"
      -B2CTenant "${{parameters.environmentName}}authncs"
      -B2CTenantFullName "${{parameters.environmentName}}authncs.onmicrosoft.com"
      -B2CSignUpPolicy "$(b2cSignUpPolicy)"
      -B2CSignupConfirmPolicy "$(b2cSignupConfirmPolicy)"
      -B2CPasswordResetConfirmPolicy "$(b2cPasswordResetConfirmPoicy)"
      -B2CClientId "${{parameters.clientId}}"
      -B2CRedirectUri "https://jwt.ms"
      -B2CAuthorizationUrl "$(b2cAuthorizationUrl)"
      -ClientSigningKey "$(clientSigningKey)"
      -SMTPServer "$(smtpServer)"
      -SMTPUsername "$(smtpUsername)"
      -SMTPPassword "$(smtpPassword)"
      -SMTPFromAddress "$(smtpFromAddress)"
      -SMTPSubject "Sign-in to NCS"
      -SignupEmailSubject "Create your account"
      -SignupConfirmationEmailSubject "Verify your account"
      -PasswordResetConfirmationEmailSubject "Verify your account"
      -AccountActivationEmailExpiryInSeconds "86400"
      -NCSApimSubscriptionKey "$(ncsApimSubscriptionKey)"
      -NCSDSSApiKey "$(ncsDssApiKey)"
      -NCSDSSSearchApiUrl "$(ncsDssSearchApiUrl)"
      -NCSDSSSearchApiVersion "$(ncsDssSearchApiVersion)"
      -NCSDSSCreateCustomerApiUrl "https://at.api.nationalcareersservice.org.uk/customers/api/Customers/"
      -NCSDSSCreateContactApiUrl "https://at.api.nationalcareersservice.org.uk/contactdetails/api/customers/{0}/ContactDetails/"
      -NCSDSSCreateIdentityApiUrl "https://at.api.nationalcareersservice.org.uk/digitalidentities/api/identity"
      -TouchpointId "1000000000"
      -B2CGraphAccessClientId "${{parameters.graphAccessClientId}}"
      -B2CGraphAccessClientSecret "${{parameters.graphAccessClientSecret}}"
      -EmailChangeConfirmationEmailSubjectNewEmail "Email change request"
      -EmailChangeConfirmationEmailSubjectOldEmail "Email change request"
      -B2CChangeEmailPolicy "B2C_1A_changeemail"
      -ExtensionAppId "9509a3af9e674a7d9443a094c02c8e69"
      '
      eapimRegister: ${{parameters.deployApim}}
      eapimServiceConnection: $(eapimServiceConnection)
      eapimEnvironment: ${{parameters.eapimEnvironmentName}}
      eapimProductName: 'NCS Identity'
      eapimProductContactEmail: paul.sheridan@digital.education.gov.uk
      eapimApiPublishedName: 'NCS Identity'
      eapimApiOpenApiSchemaPath: '/api/swagger'
      eapimApiPublishedPath: ncsauth
      eapimApiXmlPolicyPath: '$(Build.SourcesDirectory)/eapim/api/policy.xml'