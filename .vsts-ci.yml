name: $(BuildDefinitionName)_tag-$(BuildID)_at-$(Date:yyyyMMdd)$(Rev:.r)
resources:
  repositories:
    - repository: self
      persistCredentials: true
      clean: true
    - repository: devopsTemplates
      type: github
      endpoint: DfE-Digital
      name: DFE-Digital/operations-devops-pipeline-templates

trigger:
  branches:
    include:
    - master
    exclude:
    - develop/*

variables:
  applicationName: ncsauth

stages:
- stage: build
  displayName: Build
  jobs:
  - template: /Application/dotnet/jobs/build-application.yml@devopsTemplates
    parameters:
      applicationName: $(applicationName)
      webPublish: false

- stage: deployDev
  displayName: Deploy - DEV
  dependsOn: build
  jobs:
  - template: yaml/jobs/deploy.yml
    parameters:
      environmentName: 'dev'
      environmentId: 'd01'
      serviceConnection: $(devServiceConnection)
      subscriptionId: $(devSubscriptionId)
      deploymentPrimaryLocation: $(deploymentPrimaryLocation)
      deploymentSecondaryLocation: $(deploymentSecondaryLocation)
      deployApim: true

- stage: postDeployDev
  displayName: Post Deploy - DEV
  dependsOn: deployDev
  jobs:
  - job: azCli
    displayName: Add App Registrations
    pool:
      vmImage: ubuntu-latest
    steps:
    - template: yaml/steps/add-service-principals.yml
      parameters:
        serviceConnection: $(devB2cConnection)
        environmentName: 'dev'
        identityFrameworkSecret: $(identityFrameworkSecret)
        proxyIdentityFrameworkSecret: $(proxyIdentityFrameworkSecret)
        graphAccessSecret: $(graphAccessSecret)

- stage: deployTest
  displayName: Deploy - TEST
  dependsOn: build
  jobs:
  - template: yaml/jobs/deploy.yml
    parameters:
      environmentName: 'test'
      environmentId: 't01'
      serviceConnection: $(testServiceConnection)
      subscriptionId: $(testSubscriptionId)
      deploymentPrimaryLocation: $(deploymentPrimaryLocation)
      deploymentSecondaryLocation: $(deploymentSecondaryLocation)
      deployApim: false

- stage: postDeployDev
  displayName: Post Deploy - DEV
  dependsOn: deployTest
  jobs:
  - job: azCli
    displayName: Add App Registrations
    pool:
      vmImage: ubuntu-latest
    steps:
    - template: yaml/steps/add-service-principals.yml
      parameters:
        serviceConnection: $(testB2cConnection)
        environmentName: 'test'
        identityFrameworkSecret: $(devIdentPrincipalSecret)
        proxyIdentityFrameworkSecret: $(devIdentProxyPrincipalSecret)
        graphAccessSecret: $(devGraphPrincipalSecret)

- stage: postDeployTest
  displayName: Post Deploy - TEST
  dependsOn: deployTest
  jobs:
  - job: azCli
    displayName: Add App Registrations
    pool:
      vmImage: ubuntu-latest
    steps:
    - template: yaml/steps/add-service-principals.yml
      parameters:
        serviceConnection: $(testB2cConnection)
        environmentName: 'test'
        identityFrameworkSecret: $(testIdentPrincipalSecret)
        proxyIdentityFrameworkSecret: $(testIdentProxyPrincipalSecret)
        graphAccessSecret: $(testGraphPrincipalSecret)