name: $(BuildDefinitionName)_tag-$(BuildID)_at-$(Date:yyyyMMdd)$(Rev:.r)
resources:
  repositories:
    - repository: self
      persistCredentials: true
      clean: true
    - repository: devopsTemplates
      type: github
      endpoint: DfE-Digital
      name: DFE-Digital/operations-devops-pipeline-templates

trigger:
  branches:
    include:
    - master
    - develop

variables:
- name: applicationName
  value: authncs
- name: parsedTestExtensionAppId
  value: $[ replace(variables['testProxyIdentityAppClientId'],'-','') ]
- name: parsedDevExtensionAppId
  value: $[ replace(variables['devProxyIdentityAppClientId'],'-','') ]
- group: ncs-b2c-global

stages:

- stage: build
  displayName: Build
  jobs:
  - template: /Application/dotnet/jobs/build-application.yml@devopsTemplates
    parameters:
      applicationName: $(applicationName)
      webPublish: false
      nugetConfigPath: /nuget.config
      
- stage: testTenantSetup
  displayName: Tenant Setup - TEST
  dependsOn:
  - build
  jobs:
  - template: yaml/jobs/tenant-setup.yml
    parameters:
      applicationName: $(applicationName)
      environmentName: test
      tenantId: $(testAzureB2cTenantId)
      uploaderPrincipalClientId: $(testPipelineMangementClientId)
      uploaderPrincipalClientSecret: $(testPipelineManagementClientSecret)
      proxyAppRegistrationClientId: $(testProxyIdentityAppClientId)
      proxyAppRegistrationObjectId: $(testProxyIdentityAppObjectId)
      identAppRegistrationClientId: $(testIdentityAppClientId)
      signinRedirectRoot: test-interactions.signin.education.gov.uk
      eapimRootUrl: test-api-customerengagement.platform.education.gov.uk

- stage: devTenantSetup
  displayName: Tenant Setup - DEV
  dependsOn:
    - build
  jobs:
  - template: yaml/jobs/tenant-setup.yml
    parameters:
      applicationName: $(applicationName)
      environmentName: dev
      tenantId: $(devAzureB2cTenantId)
      uploaderPrincipalClientId: $(devPipelineManagementClientId)
      uploaderPrincipalClientSecret: $(devPipelineManagementClientSecret)
      proxyAppRegistrationClientId: $(devProxyIdentityAppClientId)
      proxyAppRegistrationObjectId: $(devProxyIdentityAppObjectId)
      identAppRegistrationClientId: $(devIdentityAppClientId)
      signinRedirectRoot: s141d01-signin-int.azurewebsites.net
      eapimRootUrl: dev-api-customerengagement.platform.education.gov.uk

- stage: deployTest
  displayName: Deploy - TEST
  dependsOn:
  - build
  - testTenantSetup
  jobs:
  - template: yaml/jobs/deploy.yml
    parameters:
      applicationName: $(applicationName)
      environmentName: 'test'
      functionServicePlanSkuName: $(functionServicePlanSkuName)
      functionServicePlanSkuTier: $(functionServicePlanSkuTier)
      functionServicePlanSkuCount: $(functionServicePlanSkuCount)
      b2cSignUpPolicy: $(b2cSignUpPolicy)
      b2cSignupConfirmPolicy: $(b2cSignupConfirmPolicy)
      b2cPasswordResetConfirmPoicy: $(b2cPasswordResetConfirmPoicy)
      b2cChangeEmailPolicy: $(b2cChangeEmailPolicy)
      b2cAuthorizationUrl: $(b2cAuthorizationUrl)
      ncsApimSubscriptionKey: $(ncsApimSubscriptionKey)
      ncsDssApiKey: $(ncsDssApiKey)
      ncsDssSearchApiUrl: $(ncsDssSearchApiUrl)
      ncsDssSearchApiVersion: $(ncsDssSearchApiVersion)
      environmentId: 't01'
      serviceConnection: $(testServiceConnection)
      eapimServiceConnection: $(eapimServiceConnection)
      subscriptionId: $(testSubscriptionId)
      relyingPartyAppClientId: $(testRelyAppClientId)
      clientSigningKey: $(testClientSigningKey)
      graphAccessClientId: $(testGraphAccessClientId)
      graphAccessClientSecret: $(testGraphAccessClientSecret)
      deploymentPrimaryLocation: $(deploymentPrimaryLocation)
      deploymentSecondaryLocation: $(deploymentSecondaryLocation)
      eapimEnvironmentName: 'Test'
      extensionAppId: $(parsedTestExtensionAppId)

- stage: deployDev
  displayName: Deploy - DEV
  dependsOn:
  - build
  - devTenantSetup
  jobs:
  - template: yaml/jobs/deploy.yml
    parameters:
      applicationName: $(applicationName)
      environmentName: 'dev'
      functionServicePlanSkuName: $(functionServicePlanSkuName)
      functionServicePlanSkuTier: $(functionServicePlanSkuTier)
      functionServicePlanSkuCount: $(functionServicePlanSkuCount)
      b2cSignUpPolicy: $(b2cSignUpPolicy)
      b2cSignupConfirmPolicy: $(b2cSignupConfirmPolicy)
      b2cPasswordResetConfirmPoicy: $(b2cPasswordResetConfirmPoicy)
      b2cChangeEmailPolicy: $(b2cChangeEmailPolicy)
      b2cAuthorizationUrl: $(b2cAuthorizationUrl)
      ncsApimSubscriptionKey: $(ncsApimSubscriptionKey)
      ncsDssApiKey: $(ncsDssApiKey)
      ncsDssSearchApiUrl: $(ncsDssSearchApiUrl)
      ncsDssSearchApiVersion: $(ncsDssSearchApiVersion)
      environmentId: 'd01'
      serviceConnection: $(devServiceConnection)
      eapimServiceConnection: $(eapimServiceConnection)
      subscriptionId: $(devSubscriptionId)
      relyingPartyAppClientId: $(devRelyAppClientId)
      clientSigningKey: $(devClientSigningKey)
      graphAccessClientId: $(devGraphAccessClientId)
      graphAccessClientSecret: $(devGraphAccessClientSecret)
      deploymentPrimaryLocation: $(deploymentPrimaryLocation)
      deploymentSecondaryLocation: $(deploymentSecondaryLocation)
      eapimEnvironmentName: 'Development'
      extensionAppId: $(parsedDevExtensionAppId)